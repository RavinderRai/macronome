{#
Constraint Parser Prompt Template

Parses constraints from user message and merges with existing preferences.
#}
You are parsing meal constraints from a user's message in a meal recommendation app.

{% if chat_history %}
**Recent Chat History:**
{% for msg in chat_history %}
{{ msg.role }}: {{ msg.content }}
{% endfor %}

{% endif %}
**User's Message:**
{{ message }}

**Existing User Preferences:**

**Filter Constraints (from UI):**
- Calories: {{ existing_calories if existing_calories else "Not set" }}
- Macros: {{ existing_macros | tojson(indent=2) if existing_macros else "Not set" }}
- Diet: {{ existing_diet if existing_diet else "Not set" }}
- Allergies/Excluded Ingredients: {{ existing_allergies | tojson if existing_allergies else "[]" }}
- Prep Time: {{ existing_prep_time if existing_prep_time else "Not set" }} minutes
- Meal Type: {{ existing_meal_type if existing_meal_type else "Not set" }}

**Custom Constraints (from chat):**
{{ existing_custom_constraints | tojson(indent=2) if existing_custom_constraints else "{}" }}
- Custom preferences like: spicy, quick, comfort_food, cuisine types, etc.

---

**Your Task:**
1. Extract NEW constraints from the user's message
2. Categorize them into the correct field:
   - **calories**: Target calories (integer)
   - **macros**: Macro targets {carbs, protein, fat} in grams
   - **diet**: Diet type (single string: "vegan", "keto", "vegetarian", etc.)
   - **allergies**: Allergies/excluded ingredients (list of strings)
   - **prep_time**: Maximum prep time in minutes (integer)
   - **meal_type**: Meal type ("breakfast", "lunch", "snack", "dinner", "dessert")
   - **custom_constraints**: Anything else (spicy, quick, cuisine, comfort_food, etc.) - store as dict

3. MERGE with existing preferences:
   - For lists (allergies): ADD new items (don't remove existing unless user explicitly says "remove")
   - For values (calories, diet, prep_time, meal_type): UPDATE with new values
   - For dicts (macros, custom_constraints): MERGE keys (add new, update existing)

4. Return the COMPLETE merged preferences (existing + new)

5. Generate a natural confirmation message (e.g., "I've added vegan to your diet preferences" or "Updated your calorie target to 700")

**Important Guidelines:**
- If user says "vegan" or "vegetarian" → set `diet = "vegan"` or `diet = "vegetarian"` (single value, not list)
- If user says "exclude peanuts" or "I'm allergic to peanuts" → add "peanuts" to `allergies` list
- If user says "spicy" or "quick" → add to `custom_constraints` dict (e.g., `{"spicy": true}` or `{"quick": true}`)
- If user says "under 700 calories" → set `calories = 700`
- If user says "30 minute meal" or "quick" → set `prep_time = 30` AND add `{"quick": true}` to `custom_constraints`
- If user mentions cuisine (Italian, Thai, etc.) → add to `custom_constraints` (e.g., `{"cuisine": "italian"}`)
- If user says "breakfast" or "lunch" → set `meal_type = "breakfast"` or `meal_type = "lunch"`
- Macros go in `macros` as {carbs, protein, fat} in grams

**Response Format:**
Return ConstraintParserOutput with:
- `updated_constraints`: Complete FilterConstraints with ALL fields (merged existing + new)
- `confirmation_message`: Natural language confirmation (e.g., "I've added vegan to your diet preferences and Italian to your favorite cuisines")

